---
title: "Amazon Video Games Recommendation"
author: 'Chicago Booth ML Team'
output: pdf_document
fontsize: 12
geometry: margin=0.6in
---


# Load Libraries & Modules

```{r message=FALSE, warning=FALSE, results='hide'}
library(data.table)
library(jsonlite)
library(recommenderlab)
```


# Import Data

```{r message=FALSE, warning=FALSE, results='hide'}
file_connection <- gzcon(url('https://github.com/ChicagoBoothML/MachineLearning_Fall2015/raw/master/Programming%20Scripts/Lecture07/hw/videoGames.json.gz'))

data <- stream_in(file_connection)

ratings <- data.table(data[c('reviewerID', 'itemID', 'rating')])

# create a rating matrix
rating_matrix <- as(ratings, 'realRatingMatrix')

# we keep users that have rated more than 2 video games
# and games that have been rated more than 2 users
while ((min(rowCounts(rating_matrix)) < 3) &&
       (min(colCounts(rating_matrix)) < 3)) {
  rating_matrix <- rating_matrix[
    rowCounts(rating_matrix) >= 3,
    colCounts(rating_matrix) >= 3]
}
```

```{r}
rating_matrix
```


# User who has rated the most Games

```{r}
user_with_most_ratings <- row.names(rating_matrix)[which.max(rowCounts(rating_matrix))]

user_with_most_ratings
```


# Game that has been rated most times by Users

```{r}
game_with_most_ratings <- colnames(rating_matrix)[which.max(colCounts(rating_matrix))]

game_with_most_ratings
```


# Split Ratings Data into Training & Test sets

Let's now establish a RecommenderLab Evaluation Scheme, which involves splitting the **`ratings`** into a Training set and a Test set:

```{r}
train_proportion <- .5
nb_of_given_ratings_per_test_user <- 2

evaluation_scheme <- evaluationScheme(
  rating_matrix, 
  method='split',
  train=train_proportion,
  k=1,
  given=nb_of_given_ratings_per_test_user)

evaluation_scheme
```

The data sets split out are as follows:

- Training data:

```{r}
ratings_train <- getData(evaluation_scheme, 'train')

ratings_train
```

- Test data: "known"/"given" ratings:

```{r}
ratings_test_known <- getData(evaluation_scheme, 'known')

ratings_test_known
```

- Test data: "unknown" ratings to be predicted and evaluated against:

```{r}
ratings_test_unknown <- getData(evaluation_scheme, 'unknown')

ratings_test_unknown
```


# Video Game Recommenders

Let's now train a number of recommendation models. The methods available in the **`recommenderlab`** package are:

```{r}
recommenderRegistry$get_entry_names()
```

The descriptions and default parameters for the methods applicable to a Real Rating Matrix are as follows:

```{r}
recommenderRegistry$get_entries(dataType='realRatingMatrix')
```


## Popularity-Based Recommender

The description and default parameters of this method in **`recommenderlab`** are as follows:

```{r}
recommenderRegistry$get_entry('POPULAR', dataType='realRatingMatrix')
```

We train a popularity-based recommender as follows:

```{r}
popular_rec <- Recommender(
  data=ratings_train,
  method='POPULAR')

popular_rec
```


## User-Based Collaborative-Filtering Recommender

The description and default parameters of this method in **`recommenderlab`** are as follows:

```{r}
recommenderRegistry$get_entry('UBCF', dataType='realRatingMatrix')
```

We train a UBCF recommender as follows:

```{r}
# User-based Collaborative Filtering Recommender
user_based_cofi_rec <- Recommender(
  data=ratings_train,
  method='UBCF',           # User-Based Collaborative Filtering
  parameter=list(
    normalize='center',    # normalizing by subtracting average rating per user;
                           # note that we don't scale by standard deviations here;
                           # we are assuming people rate on the same scale but have
                           # different biases
    method='Pearson',      # use Pearson correlation
    nn=30                  # number of Nearest Neighbors for calibration
  ))

user_based_cofi_rec
```


# Model Evaluation

Now, we make predictions on the Test set and and evaluate these recommenders' OOS performances:

```{r}
popular_rec_pred <- predict(
  popular_rec,
  ratings_test_known,
  type='ratings')

popular_rec_pred_acc <- calcPredictionAccuracy(
  popular_rec_pred,
  ratings_test_unknown)

popular_rec_pred_acc
```

```{r}
user_based_cofi_rec_pred <- predict(
  user_based_cofi_rec,
  ratings_test_known,
  type='ratings')

user_based_cofi_rec_pred_acc <- calcPredictionAccuracy(
  user_based_cofi_rec_pred,
  ratings_test_unknown)

user_based_cofi_rec_pred_acc
```
